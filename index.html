<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Helvetica+Neue:wght@300;400;700&display=swap');
    :root {
      --base-bgcolor: #ffffff;
      --base-color: #354152;
      --base-font-weight: 300;
      --base-font-size: 1rem;
      --base-line-height: 1.5;
      --base-font-family: 'Helvetica Neue', sans-serif;
      --input-bg: #f0f0f0;
      --input-border: black;
      --input-border-focus: black;
      --error-color: #e74c3c;
      --success-color: #2ecc71;
    }
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      min-height: 100vh;
      background-color: black;
      color: var(--base-color);
      font: var(--base-font-weight) var(--base-font-size)/var(--base-line-height) var(--base-font-family);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    /* Matrix canvas background */
#normsMatrix {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: -1; /* behind everything */
  pointer-events: none; /* allow clicking/scrolling */
}
    .login {
      background: #fff;
      padding: 30px 40px;
      border-radius: 8px;
      width: 360px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }
    .login svg.site__logo {
      display: block;
      margin: 0 auto 15px auto;
      fill: url(#a);
    }
    body {
  font-family: 'Lora', serif;
  font-size: 16px;
  line-height: 1.6;
  color: #333;
}

.login h2 {
  text-align: center;
  margin-bottom: 25px;
  font-weight: 600;
  color: var(--base-color);
  font-family: 'Poppins', sans-serif;
}
    form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .form__field {
      position: relative;
    }
    input[type="email"],
    input[type="password"] {
      width: 100%;
      padding: 10px 40px 10px 12px;
      background: var(--input-bg);
      border: 1.5px solid var(--input-border);
      border-radius: 5px;
      color: var(--base-color);
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    input[type="email"]:focus,
    input[type="password"]:focus {
      border-color: var(--input-border-focus);
      outline: none;
    }
    .eye-toggle {
      position: absolute;
      right: 12px;
      top: 35%;
      transform: translateY(-50%);
      cursor: pointer;
      font-size: 20px;
      user-select: none;
      color: var(--base-color);
    }
    button {
      padding: 12px;
      background: #0a0a23;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover:not(:disabled) {
      background: blue;
    }
    button:disabled {
      background: blue;
      cursor: not-allowed;
    }
    .error-msg {
      color: var(--error-color);
      font-size: 0.85rem;
      margin-top: 4px;
      min-height: 18px;
    }
    .success-msg {
      color: var(--success-color);
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 10px;
    }
    .redirect-register {
      text-align: center;
      margin-top: 15px;
      font-size: 0.9rem;
      color: var(--base-color);
    }
    .redirect-register a {
      color: var(--input-border-focus);
      text-decoration: none;
      font-weight: 600;
    }
    .redirect-register a:hover {
      text-decoration: underline;
    }
    .forgot-password {
      text-align: right;
      font-size: 0.9rem;
      color: var(--input-border-focus);
      cursor: pointer;
      user-select: none;
    }
    .forgot-password:hover {
      text-decoration: underline;
    }
    /* Modal for forgot password */
    #forgotModal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0; top: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    #forgotModal.active {
      display: flex;
    }
    #forgotModal .modal-content {
      background: white;
      padding: 20px 25px;
      border-radius: 8px;
      width: 320px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      position: relative;
    }
    #forgotModal h3 {
      margin-top: 0;
      margin-bottom: 15px;
      color: var(--base-color);
      text-align: center;
    }
    #forgotModal input[type="email"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1.5px solid var(--input-border);
      font-size: 1rem;
      color: var(--base-color);
    }
    #forgotModal input[type="email"]:focus {
      border-color: var(--input-border-focus);
      outline: none;
    }
    #forgotModal button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      background: var(--input-border-focus);
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s ease;
    }
    #forgotModal button:hover:not(:disabled) {
      background: blue;
    }
    #forgotModal button:disabled {
      background: blue;
      cursor: not-allowed;
    }
    #forgotModal .close-btn {
      position: absolute;
      right: 12px;
      top: 12px;
      cursor: pointer;
      font-size: 20px;
      color: var(--error-color);
      user-select: none;
    }
    #forgotModal .modal-error {
      color: var(--error-color);
      font-size: 0.85rem;
      min-height: 18px;
      margin-bottom: 8px;
    }
    #forgotModal .modal-success {
      color: var(--success-color);
      font-size: 0.9rem;
      text-align: center;
      margin-bottom: 8px;
    }
    .remember-me {
      display: flex;
      align-items: center;
      font-size: 0.9rem;
      user-select: none;
      gap: 6px;
    }
  .logo {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 25px;
  margin-top: -10px;
}

.logo-icon {
  animation: float 3s ease-in-out infinite;
}

.logo-text {
  font-size: 24px;
  font-weight: 700;
  color: black;
  text-transform: uppercase;
  margin-top: 10px;
  font-family: 'Poppins', sans-serif;
}

.logo-text span {
  color: blue;
}

@keyframes float {
  0% { transform: translateY(0) rotate(0deg); }
  25% { transform: translateY(-12px) rotate(-2deg); }
  50% { transform: translateY(0) rotate(0deg); }
  75% { transform: translateY(-12px) rotate(2deg); }
  100% { transform: translateY(0) rotate(0deg); }
}
  </style>
</head>
<body>
    <canvas id="normsMatrix"></canvas>
  <div class="login">
         <div class="logo">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" width="150" height="80" class="logo-icon">
    <rect x="0" y="0" width="200" height="200" rx="24" fill="#0a0a0a" />
    <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="64" font-weight="700" fill="#ffffff">BM</text>
    <text x="50%" y="78%" dominant-baseline="middle" text-anchor="middle" font-size="16" fill="#38bdf8">Black Market</text>
  </svg>
  <div class="logo-text">
    BLACK <span>MARKET</span>
  </div>
</div>
    <h4>Securely Access Your Black Market Account ‚Äî Stay Connected, Stay Ahead
</h4>
    <form id="loginForm" novalidate>
      <div class="form__field">
        <input id="email" type="email" placeholder="Email (example@mail.com)" required />
        <div class="error-msg" id="emailError"></div>
      </div>
      <div class="form__field">
        <input id="password" type="password" placeholder="Password" required />
        <span class="eye-toggle" id="togglePassword" title="Show/hide password">üëÅÔ∏è</span>
        <div class="error-msg" id="passwordError"></div>
      </div>
      <label class="remember-me">
        <input type="checkbox" id="rememberMe" />
        Remember me
      </label>
      <div class="forgot-password" id="forgotPasswordBtn">Forgot password?</div>
      <div class="error-msg" id="firebaseError"></div>
      <button type="submit" id="submitBtn">Log In</button>
      <div class="success-msg" id="successMsg"></div>
<button type="button" id="googleLoginBtn" style="margin-top: 15px; background:#4285F4; color: white; border: none; padding: 10px 15px; border-radius: 5px; font-weight: bold;">
  <img src="https://img.icons8.com/color/24/000000/google-logo.png" style="vertical-align: middle; margin-right: 8px;" />
  Log in with Google
</button>
    </form>
    <div class="redirect-register">
      Don't have an account? <a href="Register.html">Register</a>
    </div>
  </div>

  <!-- Forgot Password Modal -->
  <div id="forgotModal">
    <div class="modal-content">
      <span class="close-btn" id="closeForgotModal">&times;</span>
      <h3>Reset Your Password</h3>
      <input type="email" id="forgotEmail" placeholder="Enter your registered email" />
      <div class="modal-error" id="forgotError"></div>
      <div class="modal-success" id="forgotSuccess"></div>
      <button id="sendResetBtn">Send Reset Email</button>
      </div>
  </div>

  <!-- Firebase Scripts -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
import { 
  getAuth, 
  GoogleAuthProvider, 
  signInWithPopup, 
  sendPasswordResetEmail,
  setPersistence,
  browserLocalPersistence,
  browserSessionPersistence,
  signInWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyBCZOF7uAxlygOk1ydwSP-j3BiYzyxulf4",
  authDomain: "black-market-b6eee.firebaseapp.com",
  projectId: "black-market-b6eee",
  storageBucket: "black-market-b6eee.firebasestorage.app",
  messagingSenderId: "537330859830",
  appId: "1:537330859830:web:1db4f16f760940f17c3d97",
  measurementId: "G-XN0JMTLMRW"
    };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const provider = new GoogleAuthProvider();

  // DOM Elements
  const loginForm = document.getElementById('loginForm');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const emailError = document.getElementById('emailError');
  const passwordError = document.getElementById('passwordError');
  const firebaseError = document.getElementById('firebaseError');
  const successMsg = document.getElementById('successMsg');
  const submitBtn = document.getElementById('submitBtn');
  const rememberMeCheckbox = document.getElementById('rememberMe');
  const togglePasswordBtn = document.getElementById('togglePassword');
const googleLoginBtn = document.getElementById("googleLoginBtn");
  // Forgot password modal elements
  const forgotModal = document.getElementById('forgotModal');
  const forgotPasswordBtn = document.getElementById('forgotPasswordBtn');
  const closeForgotModalBtn = document.getElementById('closeForgotModal');
  const forgotEmailInput = document.getElementById('forgotEmail');
  const forgotError = document.getElementById('forgotError');
  const forgotSuccess = document.getElementById('forgotSuccess');
  const sendResetBtn = document.getElementById('sendResetBtn');

  // Show/hide password
  togglePasswordBtn.addEventListener('click', () => {
    const type = passwordInput.type === 'password' ? 'text' : 'password';
    passwordInput.type = type;
    togglePasswordBtn.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
  });

googleLoginBtn.addEventListener("click", async () => {
  googleLoginBtn.disabled = true;
  googleLoginBtn.textContent = "Logging in with Google...";
  firebaseError.textContent = "";
  successMsg.textContent = "";

  try {
    const result = await signInWithPopup(auth, provider);
    const user = result.user;

    // Check if user exists in Firestore
    const userRef = doc(db, "users", user.uid);
    const docSnap = await getDoc(userRef);

    if (!docSnap.exists()) {
      // Create user with default role 'norms'
      await setDoc(userRef, {
        username: "",
        phone: "",
        location: "",
        email: user.email,
        displayName: user.displayName || "",
        photoURL: user.photoURL || "",
        role: "norms",
        createdAt: serverTimestamp(),
      });
      // Redirect to norms dashboard immediately
      window.location.href = "norm-dashboard.html";
    } else {
      const userData = docSnap.data();
      const role = userData.role || "norms";

      // Redirect based on role after 3 seconds delay
      setTimeout(() => {
        if (role === "admin") {
          window.location.href = "admin-dashboard.html";
        } else if (role === "frauds") {
          window.location.href = "fraud-dashboard.html";
        } else if (role === "techies") {
          window.location.href = "techie-dashboard.html";
        } else {
          window.location.href = "norm-dashboard.html";
        }
      }, 3000);
    }
  } catch (error) {
    console.error(error);
    firebaseError.textContent = "Google login failed.";
    googleLoginBtn.disabled = false;
    googleLoginBtn.textContent = "Log in with Google";
  }
});
  // Input cleanup
  emailInput.addEventListener('input', () => {
    emailError.textContent = '';
    firebaseError.textContent = '';
    successMsg.textContent = '';
  });

  passwordInput.addEventListener('input', () => {
    passwordError.textContent = '';
    firebaseError.textContent = '';
    successMsg.textContent = '';
  });

  // Email validation
  function isValidEmail(email) {
    return /\S+@\S+\.\S+/.test(email);
  }

  // Submit login
  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();

    const email = emailInput.value.trim();
    const password = passwordInput.value;
    const rememberMe = rememberMeCheckbox.checked;

    // Clear previous messages
    emailError.textContent = '';
    passwordError.textContent = '';
    firebaseError.textContent = '';
    successMsg.textContent = '';

    // Basic validation
    if (!email) {
      emailError.textContent = 'Please enter your email.';
      return;
    } else if (!isValidEmail(email)) {
      emailError.textContent = 'Please enter a valid email address.';
      return;
    }

    if (!password) {
      passwordError.textContent = 'Please enter your password.';
      return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Logging in...';


// Inside your submit handler:

const persistence = rememberMe
  ? browserLocalPersistence
  : browserSessionPersistence;

setPersistence(auth, persistence)
  .then(() => signInWithEmailAndPassword(auth, email, password))
  .then(async (userCredential) => {
    const user = userCredential.user;
    if (!user.emailVerified) {
      firebaseError.textContent = 'Email not verified. Please check your inbox and verify your email.';
      submitBtn.disabled = false;
      submitBtn.textContent = 'Log In';
      return auth.signOut();
    }

    try {
      const userRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(userRef);

      let role = "norms"; // default role fallback
      if (docSnap.exists()) {
        const userData = docSnap.data();
        role = userData.role || role;
      }

      successMsg.textContent = 'Login successful! Redirecting...';

      setTimeout(() => {
        if (role === "admin") {
          window.location.href = "admin-dashboard.html";
        } else if (role === "frauds") {
          window.location.href = "fraud-dashboard.html";
        } else if (role === "techies") {
          window.location.href = "techie-dashboard.html";
        } else {
          window.location.href = "norm-dashboard.html";
        }
      }, 1500);

    } catch (error) {
      console.error("Error fetching user role:", error);
      firebaseError.textContent = "Error determining user role.";
      submitBtn.disabled = false;
      submitBtn.textContent = "Log In";
    }
  })
    // your existing error handling here...
   .catch((error) => {
  console.log('Firebase error code:', error.code);
  console.log('Firebase error message:', error.message);

  const errorMessages = {
    'auth/user-not-found': 'This email is not registered.',
    'auth/wrong-password': 'The password you entered is incorrect.',
    'auth/invalid-email': 'Please enter a valid email address.',
    'auth/too-many-requests': 'Too many login attempts. Please try again later.',
    'auth/network-request-failed': 'Network error. Please check your connection.',
    'auth/user-disabled': 'This user account has been disabled.',
    'auth/invalid-login-credentials': 'Incorrect email or password.'  // Add this new one!
  };

  const message = errorMessages[error.code] || 'An unknown error occurred. Please try again.';
  firebaseError.textContent = message;

  submitBtn.disabled = false;
  submitBtn.textContent = 'Log In';
});
});

  // Auto-login
  auth.onAuthStateChanged(async (user) => {
  if (user && user.emailVerified) {
    successMsg.textContent = `Welcome back, ${user.email}! Redirecting...`;

    try {
      const userRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(userRef);

      if (docSnap.exists()) {
        const userData = docSnap.data();
        const role = userData.role || "norms";

        setTimeout(() => {
          if (role === "admin") {
            window.location.href = "admin-dashboard.html";
          } else if (role === "frauds") {
            window.location.href = "fraud-dashboard.html";
          } else if (role === "techies") {
            window.location.href = "techie-dashboard.html";
          } else {
            window.location.href = "norm-dashboard.html";
          }
        }, 1500);
      } else {
        // No user doc, fallback
        setTimeout(() => {
          window.location.href = "norm-dashboard.html";
        }, 1500);
      }
    } catch (error) {
      console.error("Error fetching user data:", error);
      // fallback redirect
      setTimeout(() => {
        window.location.href = "norm-dashboard.html";
      }, 1500);
    }
  }
});

  // Forgot password
  forgotPasswordBtn.addEventListener('click', () => {
    forgotModal.classList.add('active');
    forgotEmailInput.value = '';
    forgotError.textContent = '';
    forgotSuccess.textContent = '';
  });

  closeForgotModalBtn.addEventListener('click', () => {
    forgotModal.classList.remove('active');
  });

  forgotModal.addEventListener('click', (e) => {
    if (e.target === forgotModal) {
      forgotModal.classList.remove('active');
    }
  });

  sendResetBtn.addEventListener('click', () => {
    const email = forgotEmailInput.value.trim();
    forgotError.textContent = '';
    forgotSuccess.textContent = '';

    if (!email) {
      forgotError.textContent = 'Please enter your email.';
      return;
    }
    if (!isValidEmail(email)) {
      forgotError.textContent = 'Invalid email address.';
      return;
    }

    sendResetBtn.disabled = true;
    sendResetBtn.textContent = 'Sending...';

    sendPasswordResetEmail(auth, email)
  .then(() => {
    forgotSuccess.textContent = 'Reset link sent. Check your inbox.';
    sendResetBtn.disabled = false;
    sendResetBtn.textContent = 'Send Reset Email';
  })
  .catch(error => {
    let msg = 'Error sending email.';
    switch (error.code) {
      case 'auth/user-not-found':
        msg = 'No user with this email.';
        break;
      case 'auth/invalid-email':
        msg = 'Invalid email address.';
        break;
      default:
        msg = error.message;
    }
    forgotError.textContent = msg;
    sendResetBtn.disabled = false;
    sendResetBtn.textContent = 'Send Reset Email';
      });
  });
  
  const canvas = document.getElementById("normsMatrix");
const ctx = canvas.getContext("2d");
canvas.height = window.innerHeight;
canvas.width = window.innerWidth;
const letters = "01";
const fontSize = 16;
const columns = canvas.width / fontSize;
const drops = Array.from({ length: columns }).fill(1);

// Array of colors to randomly pick from
const colors = ["#0f0", "#00ffe1", "#00ff99"];

function draw() {
  ctx.fillStyle = "rgba(10, 10, 35, 0.05)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.font = fontSize + "px monospace";
  
  for (let i = 0; i < drops.length; i++) {
    // Pick a random color from the colors array for each letter
    ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)];
    
    const text = letters.charAt(Math.floor(Math.random() * letters.length));
    ctx.fillText(text, i * fontSize, drops[i] * fontSize);

    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
      drops[i] = 0;
    }
    drops[i]++;
  }
}

setInterval(draw, 35);
</script>
</body>
</html>
